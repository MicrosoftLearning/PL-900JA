---
lab:
    title: 'ラボ: Power Automate'
    module: 'モジュール 4: Power Automate を使い始める'
---

# モジュール 4: Power BI を使い始める
## ラボ: Power Automate

シナリオ
========

ベローズ カレッジは、キャンパス内に複数の建物を持つ教育機関です。キャンパスの訪問者は現在、紙の日誌に記録されています。記録は一貫して収集されておらず、キャンパス全体の訪問記録を収集して分析する手段がありません。 

キャンパス管理は、建物へのアクセスがセキュリティ担当者によって制御され、すべての訪問がホストによって事前登録され、記録される必要がある訪問者登録システムを近代化したいと考えています。

このコース全体を通して、アプリケーションを構築するとともに自動化を行って、ベローズ・カレッジの管理担当者とセキュリティ担当者がキャンパス内の建物へのアクセスを管理および制御できるようにします。 

このラボでは、キャンパス管理のさまざまな部分を自動化する Power Automate フローを作成します。 

ハイレベルのラボ手順
======================

プロジェクトの完了に必要な要件は以下のとおりです。

* 各訪問者に割り当てられた一意のコードは、訪問前に訪問者が利用できるようにする必要があります。
* セキュリティ担当者は、予定されたタイムスロットにオーバーステイしている訪問者の通知を受け取る必要があります。

## 前提条件

* ラボ 1 の完了 - データ モデリング
* ラボ 2 の第 1 部で作成されたキャンパス スタッフ アプリ – キャンバス アプリケーション (テスト用)

始める前に考慮すべきこと
-----------------------------------

-   訪問者コードの最適な分布メカニズムは何ですか。
-   オーバーステイを測定し、厳格なポリシーを実施する方法。

演習 \#1: 訪問通知フローを作成します
===============================

**目標:** この演習では要件を実装する Power Automate フローを作成します。訪問者の通知は、電子メールを使用して行われます。通知には、訪問に割り当てられた一意のコードが含まれます。

タスク \#1: フローの作成
---------------------------

1.  「Campus Management」 ソリューションを開きます。

    -   <https://make.powerapps.com> にサインインします

    -   **環境**を選択します

    -   「**ソリューション**」 を選択します。

    -   「**Campus Management**」 ソリューションをクリックして開きます。

2.  「**新規**」 をクリックして 「**フロー**」 を選択します。これにより、フロー エディターが新規ウィンドウに開きます。

3. 「**最新**」 を検索して、「**Common Data Service (現在の環境)**」 を選択します。

4. **レコードが作成された**、**更新された**、または**削除された**ときのトリガーを選択します。

   * **トリガー条件**に 「**作成**」 を選択します
   * **エンティティ名**に 「**訪問**」 を選択する
   * **範囲**に 「**組織**」 を選択する

5.  「**新しいステップ**」 をクリックします。この手順は、メールを含む訪問者情報を取得するために必要です。

6. 「**最新**」 を検索して、「**Common Data Service (現在の環境)**」 を選択します。

7. **「レコードの取得」** アクションを選択します。 

   * **エンティティ名**として 「**連絡先**」 を選択する
   * **アイテム ID** フィールドで、動的コンテンツ リストから **「訪問者 (値)」** を選択します。

8. 「**新しいステップ**」 をクリックします。これは、訪問者にメールを作成して送信する手順です。

9. 「*メール*」 を検索し、「**メール**」 コネクタを選択 し、「**メール通知を送信する**」 アクションを選択する 
   * この操作の使用条件への同意を求められたら、**「同意する」** をクリックします。
   
   * **「宛先」** フィールドを選択し、動的コンテンツ リストから **「電子メール」** を選択します。

   * **「件名」** フィールドに「**Bellows College への訪問予定**」と入力します。

   * **「メール本文」** に次のテキストを入力します。  
        *注: 動的コンテンツは、フィールドが角かっこで囲まれた場所に配置する必要があります。最初にすべてのテキストを入力してから、動的コンテンツを正しい場所に追加することをお勧めします。*

   ```
    {First Name} さま

    Bellows Campus へ {Scheduled Start} から {Scheduled End} までご訪問予定です。

    あなたのセキュリティ コードは {Code} です。他の方とは共有しないでください。訪問中にこのコードを生成する必要があります。


    お待ちしております。

    キャンパス管理
    Bellows College
   ```
   
10.  **無題** のフロー名を選択し、「**訪問通知**」という名前に変更します。

11.  **「保存」** を押します。

タスク \#2: フローを検証して、有効化します
--------------------------------

1.  作成した **Campus Staff** アプリを開きます 
2.  「+」 キーを押して新しい訪問記録を追加します
3.  必要な情報を入力し、「**保存**」 を押します
4.  フローを開き、最新の **実行**を見つけて開きます
5.  **メール** ステップを開き、電子メールの内容が正しく生成されたことを確認します。

# 演習 2: セキュリティ スイープ フローの作成

**オブジェクト:** この演習では要件を実装する Power Automate フローを作成します。セキュリティ スイープは 15 分ごとに実行され、訪問者のいずれかがスケジュールされた時間をオーバーステイした場合、セキュリティが通知されます。

## タスク 1レコードを取得するフローを作成する

1. 「Campus Management」 ソリューションを開きます。

   -   <https://make.powerapps.com> にサインインします

   -   **環境**を選択します

   -   「**ソリューション**」 を選択します。

   -   「**Campus Management**」 ソリューションをクリックして開きます。

2. 「**新規**」 をクリックして 「**フロー**」 を選択します。これにより、フロー エディターが新規ウィンドウに開きます。

3. *recurrence* (定期的なアイテム) を検索して、**スケジュール** コネクタ、**繰り返し**トリガーの順に選択します。

4. 「**間隔**」 を 「**15 分**」 に設定します

5. 「**新しい手順**」 をクリックします。「**最新**」 を検索して、「**Common Data Service (現在の環境)**」 を選択します。「**レコードの一覧表示**」 アクションを選択します。

   * 「**エンティティ名**」 に「**訪問**」と入力します
   
   * **「詳細オプションを表示」** をクリックします。

   * 「**フィルタ クエリ**」 として次の式を入力します

     ```
     statecode eq 0 and bc_actualstart ne null and bc_actualend eq null and Microsoft.Dynamics.CRM.OlderThanXMinutes(PropertyName='bc_scheduledend',PropertyValue=15)
     ```

   分割する方法

   * `statecode eq 0` はアクティブな訪問をフィルターします (Status が Active と等しい場合)
   * `bc_actualstart ne null` は、実際の開始に値がある訪問、つまりチェックインがあった訪問の検索を制限します。
   *  `bc_actualend eq null` は、チェックアウトがなかった訪問の検索を制限します (実際の終了には値がありません) 
   * `Microsoft.Dynamics.CRM.OlderThanXMinutes(PropertyName='bc_scheduledend',PropertyValue=15)`は、15 分以上前に訪問が完了してい状態の訪問を制限します。  

6.  「**新しい手順**」 をクリックします。「**適用」**」 を検索し、各アクションに対し 「**適用**」 を選択します 

7.  **「以前の手順から出力を選択」** フィールドで、動的コンテンツから **「値」** を選択します。

8.  関連レコードとして建物データを取得する

    * ループ内の 「**アクションの追加**」 をクリックします。
    * 「**最新**」 を検索して、「**Common Data Service (現在の環境)**」 を選択します。 
    * **「レコードの取得」** アクションを選択します。
    * **「レコードの取得」** の横にある **「...」** をクリックして、**「名前の変更」** を選択します。ステップ名として「**GetBuilding**」と入力します
    * 「**エンティティ名**」 として「**Buildings**」を選択します
    * **「アイテム ID」** として **「建物 (値)」** を動的コンテンツから選択します。

9.  関連レコードとして訪問者データを取得する

    * ループ内の 「**アクションの追加**」 をクリックします。
    * 「**最新**」 を検索して、「**Common Data Service (現在の環境)**」 を選択します。 
    * **「レコードの取得」** アクションを選択します。
    * **「レコードの取得」** の横にある 「...」 をクリックして、**「名前の変更」** を選択します。ステップ名として「**GetVisitor**」と入力します。
    * **エンティティ名**として、**「訪問」** を選択します。
    * **アイテム ID**として **訪問者 (値)** を動的コンテンツから選択します。
    
10.  関連レコードとして所有者データを取得する

    * ループ内の 「**アクションの追加**」 をクリックします。
    * 「**最新**」 を検索して、「**Common Data Service (現在の環境)**」 を選択します。 
    * **「レコードの取得」** アクションを選択します。
    * **「レコードの取得」** の横にある **「...」** をクリックして、**「名前の変更」** を選択します。ステップ名として「**GetUser**」を入力します。
    * **エンティティ名**として、**「訪問」** を選択します。
    * **アイテム ID**として**所有者 (値)** を動的コンテンツから選択します。

11.  **各ループに適用**内にとどまったまま、**「メール接続」** から **「メールによる通知の送信」** アクションを追加します。

12.  「**宛先**」 に電子メール アドレスを入力します

13.  **「件名」** フィールドに「訪問予定時間を超過した {**訪問者 (値)**} へ連絡」と入力 します。**「訪問者 (値)」** は、**「GetVisitor」** ステップからの動的コンテンツです。

14.  **「メール本文」** フィールドに「建物名 {**名前**} で予定時間超過が発生しました」と入力します。**名前**は、**GetBuilding**ステップからの動的コンテンツです。

15.  **「詳細オプションの表示」** をクリックします。

16.  **GetUser**ステップから、**プライマリメール**を見つけて、「CC」 フィールドに挿入します (会議主催者は電子メールのコピーを受信します)。

17.  左上隅にある**無題** のフロー名を選択し、「**セキュリティ スイープ**」に名前を変更 します。

16.  **「保存」** を押します。

## タスク #2: フローを検証して、有効化します

1. 次の条件の訪問記録を検索または作成します。
   1. アクティブなステータスがある
   2. スケジュールされた終了が過去 (15 分以上) である
   3. 実績開始日には値があります。
2. ソリューションに移動し、**セキュリティ スイープ** フローを見つけます。**「...」** をクリックし、**「編集」** をクリックします。
3. フローが開いたら、**「テスト」** をクリックします。
4. **「トリガーのアクションを実行」** を選択します。
5. **「テスト」** および **「フローの実行」** をクリックします。
6. フローが競合する場合は、**「完了」** をクリックします。 
7. **「それぞれに適用」** を展開し、**「メールによる通知の送信」** のステップを展開します。「**件名**」、「**電子メール本文**」 の値を確認してください。「**さらに表示**」 を展開し、「**CC**」 の値を確認します。
8. ソリューションに移動し、フローの横にある **「...」** をクリックして、「**オフにする**」 を選択します。これは、テスト システム上でフローがスケジュールどおりに実行されないようにするためです。

# 課題

* 建物情報を追加し、通知フローにマップします。
* 訪問コードのバーコードを生成できますか? それはいつ役に立ちますか?
* メール本文でユーザーフレンドリーな日付形式を確実にする方法とは？
* オーバーステイ情報を含むテーブルを生成し、単一のメールのみを送信することは可能ですか?
